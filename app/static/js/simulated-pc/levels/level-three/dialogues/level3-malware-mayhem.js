import { BaseDialogue } from '../../../dialogues/base-dialogue.js';
import { LevelThreeCompletionDialogue } from './index.js';

export class Level3MalwareMayhemDialogue extends BaseDialogue {
    constructor(desktop, character = 'instructor') {
        super(desktop, character);
        this.messages = [
            {
                text: "A sophisticated malware campaign is hitting the CyberQuest Gaming Championship."
            },
            {
                text: "Multiple team systems are compromised by malware disguised as 'ProGamer Boost v2.1' - a fake performance enhancement tool."
            },
            {
                text: "ðŸ” Threat Analysis:\nAttack Vector: ProGamer Boost v2.1 trojan deploying 5 malware components\nTarget: 5 malicious processes + 5 false positives to confuse analysts:"
            },
            {
                text: "â€¢ Tournament Hijacker: Massive cryptomining stealing CPU/GPU resources\nâ€¢ Account Harvester: Stealing gaming credentials and tournament data\nâ€¢ Network Spreader: Rapidly infecting all tournament systems\nâ€¢ False Positive Generator: Creating fake threats to waste your time\nâ€¢ Plus 5 legitimate programs that may appear suspicious"
            },
            {
                text: "Current Status: 5 critical malware threats active, 5 legitimate programs creating confusion. The ProGamer Boost v2.1 campaign is spreading rapidly through tournament systems."
            },
            {
                text: "You're the lead incident responder. The tournament broadcast is in 2 minutes, and we cannot afford system failures on live television."
            },
            {
                text: "Every second of delay causes:\nâ€¢ Reputation Damage: -2% per 10 seconds\nâ€¢ Financial Impact: +$5,000 per 10 seconds\nâ€¢ Data Loss Risk: Increases exponentially with each passing moment"
            },
            {
                text: "ðŸŽ¯ Two-Stage Response Protocol:\nStage 1: Process Termination (1 minute)\nIdentify and terminate exactly 5 malicious processes using Process Monitor."
            },
            {
                text: "Target the 5 ProGamer Boost v2.1 components:\nâ€¢ progamer_boost_v21.exe (main trojan)\nâ€¢ tournament_hijacker.exe (cryptomining)\nâ€¢ account_harvester.exe (credential theft)\nâ€¢ false_positive_gen.exe (confusion tool)\nâ€¢ tournament_spreader.exe (network worm)",
                example: "AVOID killing legitimate processes like:\nâ€¢ graphics_optimizer.exe (NVIDIA)\nâ€¢ stream_assistant.exe (StreamLabs)\nâ€¢ performance_monitor.exe (MSI)"
            },
            {
                text: "Stage 2: Malware Elimination (1 minute)\nScan and quarantine exactly 5 malware files while avoiding 5 false positives."
            },
            {
                text: "CRITICAL: Distinguish real threats from false positives!"
            },
            {
                text: "âš ï¸ CRITICAL WARNING - 5 False Positives Present:\nâ€¢ Graphics optimizer (NVIDIA GPU utility)\nâ€¢ Stream assistant (StreamLabs broadcasting)\nâ€¢ Tournament updater (Official CyberQuest software)\nâ€¢ Performance monitor (MSI hardware monitoring)\nâ€¢ Browser helper (Chrome gaming extension)",
                example: "Quarantining ANY legitimate file = Major reputation damage!\nOnly target the 5 actual ProGamer Boost v2.1 threats"
            },
            {
                text: "â€¢ Speed vs. Accuracy: 2 minutes total - every decision counts\nâ€¢ Analyze Before Acting: False positives cost precious time and reputation"
            },
            {
                text: "â€¢ Prioritize Real Threats: Focus on confirmed malware, not suspicious-looking legitimate files\nâ€¢ Learn from Mistakes: Each false positive teaches pattern recognition"
            },
            {
                text: "âš ï¸ Mission Critical Targets:\nâ€¢ Eliminate exactly 5 malicious processes and 5 malware files\nâ€¢ Reputation: Must stay above 50% (false positives cost 10-15% each!)\nâ€¢ Budget: Cannot exceed $100K in damages"
            },
            {
                text: "â€¢ Time: All systems operational in 2 minutes\nâ€¢ Zero Tolerance: No infected systems can remain active, no legitimate systems damaged"
            },
            {
                text: "ðŸ† Perfect Score Requirements:\nâ€¢ Kill exactly 5 malicious processes (avoid 5 legitimate ones)\nâ€¢ Quarantine exactly 5 malware files (avoid 5 false positives)\nâ€¢ Complete both stages within 2 minutes"
            },
            {
                text: "â€¢ Precision Score: Minimize false positives (every mistake costs time and reputation)"
            },
            {
                text: "ðŸ† Scoring System:\nBase XP Award: 150 XP for completing Level 3 (Intermediate Difficulty)\nAccuracy Multiplier: Up to 2x bonus for perfect malware detection (100%)"
            },
            {
                text: "Speed Bonus: Additional XP for completing both stages within 2 minutes\nPrecision Bonus: Extra XP for avoiding false positives\nMaximum Possible: ~375 XP for flawless malware response!"
            },
            {
                text: "This is the ultimate test - a 2-minute cyber crisis with global visibility. The gaming community, tournament sponsors, and your team are counting on your analytical skills under extreme pressure."
            },
            {
                text: "System Status: Active monitoring enabled\nTools Ready: Process Monitor, Malware Scanner with False Positive Detection"
            },
            {
                text: "Timer: 2 minutes starting on your command"
            },
            {
                text: "Remember: Think fast, analyze carefully, act precisely. Are you ready to save the championship?"
            }
        ];
    }

    onComplete() {
        localStorage.setItem('cyberquest_level_3_started', 'true');
        
        // Create and start the Level 3 timer globally
        this.createAndStartTimer().then(() => {
            // Initialize session summary
            this.initializeSessionSummary();
            
            // Launch Process Monitor after timer is created
            if (window.desktop && window.desktop.windowManager && window.desktop.windowManager.applicationLauncher) {
                setTimeout(async () => {
                    await window.desktop.windowManager.applicationLauncher.launchForLevel(3, 'process-monitor', 'Process Monitor');
                }, 500);
            } else if (window.applicationLauncher) {
                setTimeout(async () => {
                    await window.applicationLauncher.launchForLevel(3, 'process-monitor', 'Process Monitor');
                }, 500);
            }
        });
    }
    
    async initializeSessionSummary() {
        try {
            // Import and create the session summary
            const { Level3SessionSummary } = await import('../level3-session-summary.js');
            
            if (window.level3Timer) {
                const sessionSummary = new Level3SessionSummary(window.level3Timer);
                
                // Make it globally accessible (session will use existing session ID)
                window.level3SessionSummary = sessionSummary;
                
                console.log('[Level3Dialogue] Session summary initialized with existing session');
            }
        } catch (error) {
            console.error('[Level3Dialogue] Failed to initialize session summary:', error);
        }
    }
    
    async createAndStartTimer() {
        try {
            // Import and create timer
            const { Level3TimerApp } = await import('../apps/timer.js');
            const timer = new Level3TimerApp();
            
            // Make timer globally accessible
            window.level3Timer = timer;
            
            // Create and append timer element
            const timerElement = timer.createElement();
            document.body.appendChild(timerElement);
            
            // Initialize and start timer
            timer.initialize();
            
            console.log('[Level3Dialogue] Timer created and started successfully');
        } catch (error) {
            console.error('[Level3Dialogue] Failed to create timer:', error);
        }
    }

    getFinalButtonText() {
        return 'Begin Malware Response';
    }

    static shouldAutoStart() {
        const level3Started = localStorage.getItem('cyberquest_level_3_started');
        const level2Completed = localStorage.getItem('cyberquest_level_2_completed');
        return level2Completed && !level3Started;
    }

    static startLevel3Dialogue(desktop) {
        const dialogue = new Level3MalwareMayhemDialogue(desktop);
        dialogue.start();
    }

    // Static methods to trigger specific level-three dialogues
    static async startLevelThreeCompletionDialogue(desktop) {
        if (LevelThreeCompletionDialogue.shouldAutoStart && LevelThreeCompletionDialogue.shouldAutoStart()) {
            // Ensure no other dialogue is active
            if (window.currentDialogue) {
                window.currentDialogue.cleanup();
            }
            
            const dialogue = new LevelThreeCompletionDialogue(desktop);
            window.currentDialogue = dialogue;
            dialogue.start();
        }
    }

    // Manual trigger method for level completion
    static triggerLevelThreeCompletionDialogue(desktop) {
        // Ensure no other dialogue is active
        if (window.currentDialogue) {
            window.currentDialogue.cleanup();
        }
        
        const dialogue = new LevelThreeCompletionDialogue(desktop);
        window.currentDialogue = dialogue;
        dialogue.start();
    }

    // Start a level dialogue by name (for dialogue manager compatibility)
    async startLevelDialogue(levelDialogueName, character = 'security-analyst') {
        console.log(`[Level3DialogueManager] Starting level dialogue: ${levelDialogueName}`);
        
        switch (levelDialogueName) {
            case 'level-three-completion':
                return Level3MalwareMayhemDialogue.triggerLevelThreeCompletionDialogue(this.desktop);
            default:
                console.warn(`Unknown level-three dialogue: ${levelDialogueName}`);
        }
    }
}
