import { WindowBase } from '../../../desktop-components/window-base.js';
import { level3DataManager } from '../data/index.js';
import { getApplicationLauncher } from '../../../desktop-components/application-launcher.js';

export class MalwareScannerApp extends WindowBase {
    constructor() {
        super('malware-scanner', 'Malware Scanner', {
            width: '75%',
            height: '70%'
        });
        
        this.isScanning = false;
        this.scanResults = [];
        this.quarantinedItems = [];
        this.deletedItems = [];
        this.scanProgress = 0;
        this.currentScanFile = '';
        this.timer = window.level3Timer;
        
        // Start gradual damage if malware exists
        this.damageInterval = null;
        this.startGradualDamage();
        
        // Simplified scan files for Level 3
        this.scanFiles = [
            'C:\\Windows\\System32\\kernel32.dll',
            'C:\\Program Files\\Common Files\\system.exe',
            'C:\\Users\\Public\\Downloads\\gaming_optimizer_pro.exe', // MALWARE
            'C:\\Temp\\steam_helper.exe', // MALWARE
            'C:\\Program Files\\Common Files\\performance_monitor.exe', // MALWARE
            'C:\\Windows\\System32\\system_optimizer.exe', // MALWARE
            'C:\\Users\\trainee\\AppData\\Roaming\\chrome.exe',
            'C:\\Program Files\\Microsoft Office\\office.exe',
            'C:\\Program Files\\Steam\\steam.exe',
            'C:\\Windows\\System32\\explorer.exe'
        ];
    }

    createContent() {
        const malwareCount = Object.keys(level3DataManager.getAllMalware()).length;
        const quarantineCount = this.quarantinedItems.length;
        const deletedCount = this.deletedItems.length;
        const totalHandled = quarantineCount + deletedCount;
        
        return `
            <div class="h-full flex flex-col bg-gray-900 text-white">
                <!-- Header -->
                <div class="bg-green-800 px-4 py-3 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="bi bi-shield-check text-2xl text-white"></i>
                            <div>
                                <h2 class="text-lg font-bold text-white">Quick Malware Scanner</h2>
                                <p class="text-sm text-white">Level 3 - Tournament Security</p>
                            </div>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-white">Threats: ${malwareCount}</div>
                            <div class="text-white">Quarantined: ${quarantineCount} | Deleted: ${deletedCount}</div>
                            ${totalHandled >= malwareCount ? 
                                '<div class="bg-green-600 text-white px-2 py-1 rounded text-xs font-medium mt-1">âœ“ STAGE COMPLETE</div>' :
                                `<div class="bg-red-600 text-white px-2 py-1 rounded text-xs font-medium mt-1">${malwareCount - totalHandled} REMAINING</div>`
                            }
                        </div>
                    </div>
                </div>

                <!-- Scan Controls -->
                <div class="bg-gray-800 px-4 py-3 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-3">
                            <button id="quick-scan-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded transition-colors cursor-pointer ${this.isScanning ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="bi bi-play-circle mr-2"></i>Quick Scan
                            </button>
                            <button id="stop-scan-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition-colors cursor-pointer ${!this.isScanning ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="bi bi-stop-circle mr-2"></i>Stop
                            </button>
                            <button id="clear-results-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded transition-colors cursor-pointer">
                                <i class="bi bi-trash mr-2"></i>Clear Results
                            </button>
                        </div>
                        <button id="quarantine-view-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded transition-colors cursor-pointer">
                            <i class="bi bi-folder-lock mr-2"></i>Quarantine (${quarantineCount})
                        </button>
                    </div>
                    
                    <!-- Scan Progress -->
                    ${this.isScanning ? `
                        <div class="mt-3">
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span>Scanning: ${this.currentScanFile}</span>
                                <span>${this.scanProgress}%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${this.scanProgress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Results Area -->
                <div class="flex-1 overflow-auto">
                    ${this.renderScanResults()}
                </div>

                <!-- Status Bar -->
                <div class="bg-gray-800 px-4 py-2 border-t border-gray-700 text-sm">
                    <div class="flex justify-between items-center">
                        <span>${this.isScanning ? 'Scan in progress...' : `Scan complete - ${this.scanResults.length} threats found`}</span>
                        <span class="text-gray-400">Level 3 Tournament Mode</span>
                    </div>
                </div>
            </div>
        `;
    }

    renderScanResults() {
        if (this.scanResults.length === 0) {
            return `
                <div class="h-full flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <i class="bi bi-shield-check text-6xl mb-4"></i>
                        <p class="text-lg">No scan results yet</p>
                        <p class="text-sm">Click "Quick Scan" to start scanning for threats</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="p-4">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="bi bi-exclamation-triangle text-red-500 mr-2"></i>
                    Detected Threats (${this.scanResults.length})
                </h3>
                <div class="grid gap-3">
                    ${this.scanResults.map(threat => this.renderThreatCard(threat)).join('')}
                </div>
            </div>
        `;
    }

    renderThreatCard(threat) {
        const riskColor = level3DataManager.getRiskColor(threat.riskLevel);
        const isQuarantined = this.quarantinedItems.some(q => q.id === threat.id);
        
        return `
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 hover:bg-gray-750 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="bi bi-bug text-red-500"></i>
                            <h4 class="font-semibold">${threat.name}</h4>
                            <span class="px-2 py-1 rounded text-xs ${riskColor} bg-gray-700">${threat.riskLevel}</span>
                            <span class="px-2 py-1 rounded text-xs text-gray-300 bg-gray-700">${threat.type}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${threat.description}</p>
                        <div class="text-xs text-gray-500">
                            <div><strong>Path:</strong> ${threat.path}</div>
                            <div><strong>Size:</strong> ${threat.size}</div>
                            <div class="mt-1 text-yellow-400">
                                <strong>Damage:</strong> ${threat.reputationDamage}% reputation, $${level3DataManager.formatDamage(threat.financialDamage)}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 ml-4">
                        ${!isQuarantined ? `
                            <button class="quarantine-btn px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm transition-colors cursor-pointer" data-threat-id="${threat.id}">
                                <i class="bi bi-folder-lock mr-1"></i>Quarantine
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors cursor-pointer" data-threat-id="${threat.id}">
                                <i class="bi bi-trash mr-1"></i>Delete
                            </button>
                        ` : `
                            <div class="px-3 py-1 bg-gray-600 rounded text-sm text-center">
                                <i class="bi bi-check-circle text-green-400 mr-1"></i>Quarantined
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    async startQuickScan() {
        if (this.isScanning) return;

        this.isScanning = true;
        this.scanProgress = 0;
        this.scanResults = [];
        this.updateContent();

        const totalFiles = this.scanFiles.length;
        
        for (let i = 0; i < totalFiles; i++) {
            const filePath = this.scanFiles[i];
            const filename = filePath.split('\\').pop();
            this.currentScanFile = filename;
            this.scanProgress = Math.round(((i + 1) / totalFiles) * 100);
            
            // Check if file is malicious
            const malware = level3DataManager.getMalwareByFilename(filename);
            if (malware) {
                const threat = {
                    ...malware,
                    id: `threat_${Date.now()}_${i}`,
                    detected: new Date().toLocaleString()
                };
                this.scanResults.push(threat);
            }
            
            this.updateContent();
            
            // Simulate scan time based on malware data or use default
            const scanTime = malware ? malware.scanTime : 200;
            await this.sleep(scanTime);
        }

        this.isScanning = false;
        this.currentScanFile = '';
        this.updateContent();
        
        // Apply damage to timer if threats found
        if (this.scanResults.length > 0) {
            this.applyThreatDamage();
        }

        this.showNotification(`Scan complete! ${this.scanResults.length} threats detected`, 
                            this.scanResults.length > 0 ? 'error' : 'success');
    }

    applyThreatDamage() {
        try {
            const appLauncher = getApplicationLauncher();
            let totalReputationDamage = 0;
            let totalFinancialDamage = 0;

            this.scanResults.forEach(threat => {
                totalReputationDamage += threat.reputationDamage || 0;
                totalFinancialDamage += threat.financialDamage || 0;
            });

            if (totalReputationDamage > 0) {
                appLauncher.addReputationDamage(totalReputationDamage);
            }
            if (totalFinancialDamage > 0) {
                appLauncher.addFinancialDamage(totalFinancialDamage);
            }

            console.log(`[MalwareScanner] Applied damage: ${totalReputationDamage}% reputation, $${totalFinancialDamage}`);
        } catch (error) {
            console.error('[MalwareScanner] Failed to apply threat damage:', error);
        }
    }

    quarantineThreat(threatId) {
        const threat = this.scanResults.find(t => t.id === threatId);
        if (threat && !this.quarantinedItems.some(q => q.id === threatId)) {
            this.quarantinedItems.push({
                ...threat,
                quarantinedAt: new Date().toISOString()
            });
            
            // Remove from scan results display (but keep in array for reference)
            this.scanResults = this.scanResults.filter(t => t.id !== threatId);
            this.updateContent();
            this.showNotification(`${threat.name} quarantined successfully`, 'success');
            this.checkStageCompletion();
        }
    }

    deleteThreat(threatId) {
        const threat = this.scanResults.find(t => t.id === threatId);
        if (threat) {
            // Mark as deleted and remove from scan results
            this.deletedItems.push(threat);
            this.scanResults = this.scanResults.filter(t => t.id !== threatId);
            this.updateContent();
            this.showNotification(`${threat.name} permanently deleted`, 'success');
            this.checkStageCompletion();
        }
    }
    
    checkStageCompletion() {
        const malwareCount = Object.keys(level3DataManager.getAllMalware()).length;
        const totalHandled = this.quarantinedItems.length + this.deletedItems.length;
        
        if (totalHandled >= malwareCount) {
            this.onStageComplete();
        }
    }
    
    onStageComplete() {
        // Stop gradual damage
        if (this.damageInterval) {
            clearInterval(this.damageInterval);
            this.damageInterval = null;
        }
        
        this.showNotification('All malware threats eliminated! Launching ransomware decryptor...', 'success');
        
        setTimeout(async () => {
            if (window.applicationLauncher) {
                await window.applicationLauncher.launchForLevel(3, 'ransomware-decryptor', 'Ransomware Decryptor');
            }
        }, 2000);
    }

    startGradualDamage() {
        // Apply gradual damage every 15 seconds while malware exists in scan results
        this.damageInterval = setInterval(() => {
            const activeMalware = this.scanResults.filter(t => t.riskLevel === 'Critical' || t.riskLevel === 'High');
            if (activeMalware.length > 0 && this.timer) {
                // Apply damage based on number of active malware threats
                const reputationDamage = activeMalware.length * 3; // 3% per malware per 15 seconds
                const financialDamage = activeMalware.length * 8000; // $8K per malware per 15 seconds
                
                this.timer.addReputationDamage(reputationDamage);
                this.timer.addFinancialDamage(financialDamage);
                
                console.log(`[MalwareScanner] Gradual damage applied: ${reputationDamage}% reputation, $${financialDamage} financial`);
            }
        }, 15000); // Every 15 seconds
    }

    stopScan() {
        this.isScanning = false;
        this.currentScanFile = '';
        this.updateContent();
    }

    clearResults() {
        this.scanResults = [];
        this.updateContent();
    }

    initialize() {
        super.initialize();
        this.bindEvents();
        
        // Mark app as opened
        localStorage.setItem('cyberquest_malwarescanner_opened', 'true');
    }

    bindEvents() {
        if (!this.windowElement) return;

        // Scan controls
        const quickScanBtn = this.windowElement.querySelector('#quick-scan-btn');
        const stopScanBtn = this.windowElement.querySelector('#stop-scan-btn');
        const clearResultsBtn = this.windowElement.querySelector('#clear-results-btn');
        const quarantineViewBtn = this.windowElement.querySelector('#quarantine-view-btn');

        quickScanBtn?.addEventListener('click', () => this.startQuickScan());
        stopScanBtn?.addEventListener('click', () => this.stopScan());
        clearResultsBtn?.addEventListener('click', () => this.clearResults());
        quarantineViewBtn?.addEventListener('click', () => this.showQuarantineView());

        // Threat actions
        this.windowElement.addEventListener('click', (e) => {
            if (e.target.matches('.quarantine-btn, .quarantine-btn *')) {
                const btn = e.target.closest('.quarantine-btn');
                const threatId = btn?.dataset.threatId;
                if (threatId) this.quarantineThreat(threatId);
            }
            
            if (e.target.matches('.delete-btn, .delete-btn *')) {
                const btn = e.target.closest('.delete-btn');
                const threatId = btn?.dataset.threatId;
                if (threatId) this.deleteThreat(threatId);
            }
        });
    }

    showQuarantineView() {
        // Create modal HTML
        const modalHtml = `
            <div id="quarantine-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div class="bg-gray-800 rounded-lg w-4/5 max-w-4xl h-4/5 flex flex-col">
                    <!-- Modal Header -->
                    <div class="bg-purple-600 px-4 py-3 rounded-t-lg border-b border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="bi bi-folder-lock text-2xl text-white"></i>
                                <div>
                                    <h2 class="text-lg font-bold text-white">Quarantine Manager</h2>
                                    <p class="text-sm text-purple-100">Level 3 - Isolated Threats</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-purple-100 text-sm">${this.quarantinedItems.length} items</span>
                                <button id="close-quarantine-modal" class="text-white hover:text-red-300 transition-colors cursor-pointer">
                                    <i class="bi bi-x-lg text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Content -->
                    <div class="flex-1 overflow-auto p-4 text-white">
                        ${this.renderQuarantineContent()}
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-700 px-4 py-3 rounded-b-lg border-t border-gray-600">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-300">
                                Items in quarantine are isolated and cannot execute
                            </div>
                            <div class="flex space-x-2">
                                <button id="clear-quarantine-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition-colors cursor-pointer">
                                    <i class="bi bi-trash mr-2"></i>Clear All
                                </button>
                                <button id="close-quarantine-modal-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded transition-colors cursor-pointer">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Bind modal events
        this.bindQuarantineModalEvents();
    }

    renderQuarantineContent() {
        if (this.quarantinedItems.length === 0) {
            return `
                <div class="h-full flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <i class="bi bi-shield-check text-6xl mb-4"></i>
                        <p class="text-lg">No quarantined items</p>
                        <p class="text-sm">Threats that are quarantined will appear here</p>
                    </div>
                </div>
            `;
        }

        return `
            <div>
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="bi bi-folder-lock text-purple-400 mr-2"></i>
                    Quarantined Threats (${this.quarantinedItems.length})
                </h3>
                <div class="grid gap-3">
                    ${this.quarantinedItems.map(item => this.renderQuarantineItem(item)).join('')}
                </div>
            </div>
        `;
    }

    renderQuarantineItem(item) {
        const riskColor = level3DataManager.getRiskColor(item.riskLevel);
        const quarantineDate = new Date(item.quarantinedAt).toLocaleString();
        
        return `
            <div class="bg-gray-700 border border-gray-600 rounded-lg p-4 hover:bg-gray-650 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="bi bi-lock text-purple-400"></i>
                            <h4 class="font-semibold text-white">${item.name}</h4>
                            <span class="px-2 py-1 rounded text-xs ${riskColor} bg-gray-800">${item.riskLevel}</span>
                            <span class="px-2 py-1 rounded text-xs text-gray-300 bg-gray-800">${item.type}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${item.description}</p>
                        <div class="text-xs text-gray-500">
                            <div><strong>Original Path:</strong> ${item.path}</div>
                            <div><strong>Size:</strong> ${item.size}</div>
                            <div><strong>Quarantined:</strong> ${quarantineDate}</div>
                            <div class="mt-1 text-orange-400">
                                <strong>Potential Damage:</strong> ${item.reputationDamage}% reputation, $${level3DataManager.formatDamage(item.financialDamage)}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 ml-4">
                        <button class="restore-btn px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm transition-colors cursor-pointer" data-item-id="${item.id}">
                            <i class="bi bi-arrow-counterclockwise mr-1"></i>Restore
                        </button>
                        <button class="delete-quarantine-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors cursor-pointer" data-item-id="${item.id}">
                            <i class="bi bi-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    bindQuarantineModalEvents() {
        const modal = document.getElementById('quarantine-modal');
        if (!modal) return;

        // Close modal events
        const closeButtons = modal.querySelectorAll('#close-quarantine-modal, #close-quarantine-modal-btn');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => this.closeQuarantineModal());
        });

        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeQuarantineModal();
            }
        });

        // Clear all quarantine
        const clearAllBtn = modal.querySelector('#clear-quarantine-btn');
        clearAllBtn?.addEventListener('click', () => this.clearAllQuarantine());

        // Item actions
        modal.addEventListener('click', (e) => {
            if (e.target.matches('.restore-btn, .restore-btn *')) {
                const btn = e.target.closest('.restore-btn');
                const itemId = btn?.dataset.itemId;
                if (itemId) this.restoreFromQuarantine(itemId);
            }
            
            if (e.target.matches('.delete-quarantine-btn, .delete-quarantine-btn *')) {
                const btn = e.target.closest('.delete-quarantine-btn');
                const itemId = btn?.dataset.itemId;
                if (itemId) this.deleteFromQuarantine(itemId);
            }
        });
    }

    closeQuarantineModal() {
        const modal = document.getElementById('quarantine-modal');
        if (modal) {
            modal.remove();
        }
    }

    restoreFromQuarantine(itemId) {
        const itemIndex = this.quarantinedItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            const item = this.quarantinedItems[itemIndex];
            
            // Remove from quarantine
            this.quarantinedItems.splice(itemIndex, 1);
            
            // Add back to scan results
            this.scanResults.push(item);
            
            // Update displays
            this.updateQuarantineModal();
            this.updateContent();
            
            this.showNotification(`${item.name} restored from quarantine`, 'info');
        }
    }

    deleteFromQuarantine(itemId) {
        const itemIndex = this.quarantinedItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            const item = this.quarantinedItems[itemIndex];
            
            // Remove from quarantine permanently
            this.quarantinedItems.splice(itemIndex, 1);
            
            // Update displays
            this.updateQuarantineModal();
            this.updateContent();
            
            this.showNotification(`${item.name} permanently deleted`, 'success');
        }
    }

    clearAllQuarantine() {
        if (this.quarantinedItems.length === 0) return;
        
        const count = this.quarantinedItems.length;
        this.quarantinedItems = [];
        
        // Update displays
        this.updateQuarantineModal();
        this.updateContent();
        
        this.showNotification(`${count} items cleared from quarantine`, 'success');
    }

    updateQuarantineModal() {
        const modal = document.getElementById('quarantine-modal');
        if (modal) {
            // Update item count in header
            const itemCount = modal.querySelector('.text-purple-100');
            if (itemCount) {
                itemCount.textContent = `${this.quarantinedItems.length} items`;
            }
            
            // Update content
            const content = modal.querySelector('.flex-1.overflow-auto');
            if (content) {
                content.innerHTML = `<div class="p-4 text-white">${this.renderQuarantineContent()}</div>`;
            }
        }
    }

    showNotification(message, type = 'info') {
        if (window.toastManager && window.toastManager.showToast) {
            window.toastManager.showToast(message, type);
        } else {
            console.log(`[MalwareScanner] ${type.toUpperCase()}: ${message}`);
        }
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    cleanup() {
        this.stopScan();
        
        // Stop gradual damage interval
        if (this.damageInterval) {
            clearInterval(this.damageInterval);
            this.damageInterval = null;
        }
        
        super.cleanup();
    }
}