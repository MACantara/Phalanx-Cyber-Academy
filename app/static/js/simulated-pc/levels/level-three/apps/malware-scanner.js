import { WindowBase } from '../../../desktop-components/window-base.js';
import { level3DataManager } from '../data/index.js';
import { getApplicationLauncher } from '../../../desktop-components/application-launcher.js';

export class MalwareScannerApp extends WindowBase {
    constructor() {
        super('malware-scanner', 'Malware Scanner', {
            width: '75%',
            height: '70%'
        });
        
        this.isScanning = false;
        this.scanResults = [];
        this.quarantinedItems = [];
        this.scanProgress = 0;
        this.currentScanFile = '';
        
        // Simplified scan files for Level 3
        this.scanFiles = [
            'C:\\Windows\\System32\\kernel32.dll',
            'C:\\Program Files\\Common Files\\system.exe',
            'C:\\Users\\Public\\Downloads\\gaming_optimizer_pro.exe', // MALWARE
            'C:\\Temp\\steam_helper.exe', // MALWARE
            'C:\\Program Files\\Common Files\\performance_monitor.exe', // MALWARE
            'C:\\Windows\\System32\\system_optimizer.exe', // MALWARE
            'C:\\Users\\trainee\\AppData\\Roaming\\chrome.exe',
            'C:\\Program Files\\Microsoft Office\\office.exe',
            'C:\\Program Files\\Steam\\steam.exe',
            'C:\\Windows\\System32\\explorer.exe'
        ];
    }

    createContent() {
        const malwareCount = Object.keys(level3DataManager.getAllMalware()).length;
        const quarantineCount = this.quarantinedItems.length;
        
        return `
            <div class="h-full flex flex-col bg-gray-900 text-white">
                <!-- Header -->
                <div class="bg-green-800 px-4 py-3 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="bi bi-shield-check text-2xl text-white"></i>
                            <div>
                                <h2 class="text-lg font-bold text-white">Quick Malware Scanner</h2>
                                <p class="text-sm text-white">Level 3 - Tournament Security</p>
                            </div>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-white">Threats: ${malwareCount}</div>
                            <div class="text-white">Quarantined: ${quarantineCount}</div>
                        </div>
                    </div>
                </div>

                <!-- Scan Controls -->
                <div class="bg-gray-800 px-4 py-3 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-3">
                            <button id="quick-scan-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded transition-colors cursor-pointer ${this.isScanning ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="bi bi-play-circle mr-2"></i>Quick Scan
                            </button>
                            <button id="stop-scan-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded transition-colors cursor-pointer ${!this.isScanning ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="bi bi-stop-circle mr-2"></i>Stop
                            </button>
                            <button id="clear-results-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded transition-colors cursor-pointer">
                                <i class="bi bi-trash mr-2"></i>Clear Results
                            </button>
                        </div>
                        <button id="quarantine-view-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded transition-colors cursor-pointer">
                            <i class="bi bi-folder-lock mr-2"></i>Quarantine (${quarantineCount})
                        </button>
                    </div>
                    
                    <!-- Scan Progress -->
                    ${this.isScanning ? `
                        <div class="mt-3">
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span>Scanning: ${this.currentScanFile}</span>
                                <span>${this.scanProgress}%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${this.scanProgress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Results Area -->
                <div class="flex-1 overflow-auto">
                    ${this.renderScanResults()}
                </div>

                <!-- Status Bar -->
                <div class="bg-gray-800 px-4 py-2 border-t border-gray-700 text-sm">
                    <div class="flex justify-between items-center">
                        <span>${this.isScanning ? 'Scan in progress...' : `Scan complete - ${this.scanResults.length} threats found`}</span>
                        <span class="text-gray-400">Level 3 Tournament Mode</span>
                    </div>
                </div>
            </div>
        `;
    }

    renderScanResults() {
        if (this.scanResults.length === 0) {
            return `
                <div class="h-full flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <i class="bi bi-shield-check text-6xl mb-4"></i>
                        <p class="text-lg">No scan results yet</p>
                        <p class="text-sm">Click "Quick Scan" to start scanning for threats</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="p-4">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="bi bi-exclamation-triangle text-red-500 mr-2"></i>
                    Detected Threats (${this.scanResults.length})
                </h3>
                <div class="grid gap-3">
                    ${this.scanResults.map(threat => this.renderThreatCard(threat)).join('')}
                </div>
            </div>
        `;
    }

    renderThreatCard(threat) {
        const riskColor = level3DataManager.getRiskColor(threat.riskLevel);
        const isQuarantined = this.quarantinedItems.some(q => q.id === threat.id);
        
        return `
            <div class="bg-gray-800 border border-gray-700 rounded-lg p-4 hover:bg-gray-750 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="bi bi-bug text-red-500"></i>
                            <h4 class="font-semibold">${threat.name}</h4>
                            <span class="px-2 py-1 rounded text-xs ${riskColor} bg-gray-700">${threat.riskLevel}</span>
                            <span class="px-2 py-1 rounded text-xs text-gray-300 bg-gray-700">${threat.type}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">${threat.description}</p>
                        <div class="text-xs text-gray-500">
                            <div><strong>Path:</strong> ${threat.path}</div>
                            <div><strong>Size:</strong> ${threat.size}</div>
                            <div class="mt-1 text-yellow-400">
                                <strong>Damage:</strong> ${threat.reputationDamage}% reputation, $${level3DataManager.formatDamage(threat.financialDamage)}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 ml-4">
                        ${!isQuarantined ? `
                            <button class="quarantine-btn px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm transition-colors cursor-pointer" data-threat-id="${threat.id}">
                                <i class="bi bi-folder-lock mr-1"></i>Quarantine
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-colors cursor-pointer" data-threat-id="${threat.id}">
                                <i class="bi bi-trash mr-1"></i>Delete
                            </button>
                        ` : `
                            <div class="px-3 py-1 bg-gray-600 rounded text-sm text-center">
                                <i class="bi bi-check-circle text-green-400 mr-1"></i>Quarantined
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    async startQuickScan() {
        if (this.isScanning) return;

        this.isScanning = true;
        this.scanProgress = 0;
        this.scanResults = [];
        this.updateContent();

        const totalFiles = this.scanFiles.length;
        
        for (let i = 0; i < totalFiles; i++) {
            const filePath = this.scanFiles[i];
            const filename = filePath.split('\\').pop();
            this.currentScanFile = filename;
            this.scanProgress = Math.round(((i + 1) / totalFiles) * 100);
            
            // Check if file is malicious
            const malware = level3DataManager.getMalwareByFilename(filename);
            if (malware) {
                const threat = {
                    ...malware,
                    id: `threat_${Date.now()}_${i}`,
                    detected: new Date().toLocaleString()
                };
                this.scanResults.push(threat);
            }
            
            this.updateContent();
            
            // Simulate scan time based on malware data or use default
            const scanTime = malware ? malware.scanTime : 200;
            await this.sleep(scanTime);
        }

        this.isScanning = false;
        this.currentScanFile = '';
        this.updateContent();
        
        // Apply damage to timer if threats found
        if (this.scanResults.length > 0) {
            this.applyThreatDamage();
        }

        this.showNotification(`Scan complete! ${this.scanResults.length} threats detected`, 
                            this.scanResults.length > 0 ? 'error' : 'success');
    }

    applyThreatDamage() {
        try {
            const appLauncher = getApplicationLauncher();
            let totalReputationDamage = 0;
            let totalFinancialDamage = 0;

            this.scanResults.forEach(threat => {
                totalReputationDamage += threat.reputationDamage || 0;
                totalFinancialDamage += threat.financialDamage || 0;
            });

            if (totalReputationDamage > 0) {
                appLauncher.addReputationDamage(totalReputationDamage);
            }
            if (totalFinancialDamage > 0) {
                appLauncher.addFinancialDamage(totalFinancialDamage);
            }

            console.log(`[MalwareScanner] Applied damage: ${totalReputationDamage}% reputation, $${totalFinancialDamage}`);
        } catch (error) {
            console.error('[MalwareScanner] Failed to apply threat damage:', error);
        }
    }

    quarantineThreat(threatId) {
        const threat = this.scanResults.find(t => t.id === threatId);
        if (threat && !this.quarantinedItems.some(q => q.id === threatId)) {
            this.quarantinedItems.push({
                ...threat,
                quarantinedAt: new Date().toISOString()
            });
            
            // Remove from scan results display (but keep in array for reference)
            this.updateContent();
            this.showNotification(`${threat.name} quarantined successfully`, 'success');
        }
    }

    deleteThreat(threatId) {
        const threat = this.scanResults.find(t => t.id === threatId);
        if (threat) {
            // Remove from scan results
            this.scanResults = this.scanResults.filter(t => t.id !== threatId);
            this.updateContent();
            this.showNotification(`${threat.name} deleted successfully`, 'success');
        }
    }

    stopScan() {
        this.isScanning = false;
        this.currentScanFile = '';
        this.updateContent();
    }

    clearResults() {
        this.scanResults = [];
        this.updateContent();
    }

    initialize() {
        super.initialize();
        this.bindEvents();
        
        // Mark app as opened
        localStorage.setItem('cyberquest_malwarescanner_opened', 'true');
    }

    bindEvents() {
        if (!this.windowElement) return;

        // Scan controls
        const quickScanBtn = this.windowElement.querySelector('#quick-scan-btn');
        const stopScanBtn = this.windowElement.querySelector('#stop-scan-btn');
        const clearResultsBtn = this.windowElement.querySelector('#clear-results-btn');
        const quarantineViewBtn = this.windowElement.querySelector('#quarantine-view-btn');

        quickScanBtn?.addEventListener('click', () => this.startQuickScan());
        stopScanBtn?.addEventListener('click', () => this.stopScan());
        clearResultsBtn?.addEventListener('click', () => this.clearResults());
        quarantineViewBtn?.addEventListener('click', () => this.showQuarantineView());

        // Threat actions
        this.windowElement.addEventListener('click', (e) => {
            if (e.target.matches('.quarantine-btn, .quarantine-btn *')) {
                const btn = e.target.closest('.quarantine-btn');
                const threatId = btn?.dataset.threatId;
                if (threatId) this.quarantineThreat(threatId);
            }
            
            if (e.target.matches('.delete-btn, .delete-btn *')) {
                const btn = e.target.closest('.delete-btn');
                const threatId = btn?.dataset.threatId;
                if (threatId) this.deleteThreat(threatId);
            }
        });
    }

    showQuarantineView() {
        // TODO: Implement quarantine view modal
        this.showNotification(`${this.quarantinedItems.length} items in quarantine`, 'info');
    }

    showNotification(message, type = 'info') {
        if (window.toastManager && window.toastManager.showToast) {
            window.toastManager.showToast(message, type);
        } else {
            console.log(`[MalwareScanner] ${type.toUpperCase()}: ${message}`);
        }
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    cleanup() {
        this.stopScan();
        super.cleanup();
    }
}