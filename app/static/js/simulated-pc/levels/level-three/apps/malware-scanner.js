import { WindowBase } from '../../../desktop-components/window-base.js';
import { level3DataManager } from '../data/index.js';

export class MalwareScannerApp extends WindowBase {
    constructor() {
        super('malware-scanner', 'Malware Scanner', {
            width: '75%',
            height: '70%'
        });
        
        this.isScanning = false;
        this.scanResults = [];
        this.quarantinedItems = [];
        this.deletedItems = [];
        this.scanProgress = 0;
        this.currentScanFile = '';
        this.falsePositiveFiles = []; // Will be populated in generateScanFilesList()
        
        // Initialize timer reference - may not be available immediately
        this.timer = null;
        this.initializeTimer();
        
        console.log('[MalwareScanner] Constructor - timer available:', !!this.timer);
        
        // Start gradual damage if malware exists
        this.damageInterval = null;
        this.startGradualDamage();
        
        // Get scan files from malware data - includes both clean and malicious files
        this.scanFiles = this.generateScanFilesList();
    }

    // Initialize timer reference with polling fallback
    initializeTimer() {
        this.timer = window.level3Timer;
        
        // If timer not available, poll for it
        if (!this.timer) {
            console.log('[MalwareScanner] Timer not immediately available, polling...');
            const pollTimer = () => {
                this.timer = window.level3Timer;
                if (this.timer) {
                    console.log('[MalwareScanner] Timer now available');
                } else {
                    // Try again in 100ms
                    setTimeout(pollTimer, 100);
                }
            };
            setTimeout(pollTimer, 100);
        }
    }

    // Generate scan files list from malware data plus clean files and false positives
    generateScanFilesList() {
        const malwareData = level3DataManager.getAllMalware();
        const malwarePaths = Object.values(malwareData).map(malware => malware.path);
        
        // Add clean files to make the scan more realistic
        const cleanFiles = [
            'C:\\Windows\\System32\\kernel32.dll',
            'C:\\Program Files\\Microsoft Office\\office.exe',
            'C:\\Windows\\System32\\explorer.exe',
            'C:\\Windows\\System32\\winlogon.exe',
            'C:\\Program Files\\Windows Defender\\MsMpEng.exe',
            'C:\\Windows\\System32\\notepad.exe'
        ];
        
        // Add false positive files - legitimate files that may appear suspicious
        this.falsePositiveFiles = [
            'C:\\Program Files\\Common Files\\system_update.exe',
            'C:\\Users\\trainee\\AppData\\Roaming\\game_optimizer.exe',
            'C:\\Program Files\\Steam\\steam_client_helper.exe',
            'C:\\Temp\\browser_cache_cleaner.exe',
            'C:\\Program Files\\Graphics Drivers\\nvidia_updater.exe'
        ];
        
        // Combine and shuffle for realistic scan order
        return [...malwarePaths, ...cleanFiles, ...this.falsePositiveFiles].sort(() => Math.random() - 0.5);
    }

    createContent() {
        const malwareCount = Object.keys(level3DataManager.getAllMalware()).length;
        const quarantineCount = this.quarantinedItems.length;
        const deletedCount = this.deletedItems.length;
        const totalHandled = quarantineCount + deletedCount;
        
        return `
            <div class="h-full flex flex-col bg-gray-900 text-white">
                <!-- Header -->
                <div class="bg-green-800 px-3 sm:px-4 py-3 border-b border-gray-700">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0">
                        <div class="flex items-center space-x-2 sm:space-x-3">
                            <i class="bi bi-shield-check text-xl sm:text-2xl text-white"></i>
                            <div>
                                <h2 class="text-base sm:text-lg font-bold text-white">Quick Malware Scanner</h2>
                                <p class="text-xs sm:text-sm text-white">Level 3 - Tournament Security</p>
                            </div>
                        </div>
                        <div class="text-left sm:text-right text-xs sm:text-sm">
                            <div class="text-white">Threats: ${malwareCount}</div>
                            <div class="text-white">Quarantined: ${quarantineCount} | Deleted: ${deletedCount}</div>
                            ${totalHandled >= malwareCount ? 
                                '<div class="bg-green-600 text-white px-2 py-1 rounded text-xs font-medium mt-1 inline-block">âœ“ STAGE COMPLETE</div>' :
                                `<div class="bg-red-600 text-white px-2 py-1 rounded text-xs font-medium mt-1 inline-block">${malwareCount - totalHandled} REMAINING</div>`
                            }
                        </div>
                    </div>
                </div>

                <!-- Scan Controls -->
                <div class="bg-gray-800 px-3 sm:px-4 py-3 border-b border-gray-700">
                    <div class="flex flex-col sm:flex-row gap-3 sm:gap-0 sm:items-center sm:justify-between">
                        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                            <button id="quick-scan-btn" class="px-3 sm:px-4 py-2 bg-green-600 hover:bg-green-700 active:bg-green-800 rounded transition-colors cursor-pointer touch-manipulation text-sm sm:text-base ${this.isScanning ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="bi bi-play-circle mr-1 sm:mr-2"></i>Quick Scan
                            </button>
                            <button id="stop-scan-btn" class="px-3 sm:px-4 py-2 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded transition-colors cursor-pointer touch-manipulation text-sm sm:text-base ${!this.isScanning ? 'opacity-50 cursor-not-allowed' : ''}">
                                <i class="bi bi-stop-circle mr-1 sm:mr-2"></i>Stop
                            </button>
                            <button id="clear-results-btn" class="px-3 sm:px-4 py-2 bg-gray-600 hover:bg-gray-700 active:bg-gray-800 rounded transition-colors cursor-pointer touch-manipulation text-sm sm:text-base">
                                <i class="bi bi-trash mr-1 sm:mr-2"></i>Clear Results
                            </button>
                        </div>
                        <button id="quarantine-view-btn" class="px-3 sm:px-4 py-2 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 rounded transition-colors cursor-pointer touch-manipulation text-sm sm:text-base">
                            <i class="bi bi-folder-lock mr-1 sm:mr-2"></i>Quarantine (${quarantineCount})
                        </button>
                    </div>
                    
                    <!-- Scan Progress -->
                    ${this.isScanning ? `
                        <div class="mt-3">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs sm:text-sm mb-1 gap-1 sm:gap-0">
                                <span class="truncate pr-2">Scanning: ${this.currentScanFile}</span>
                                <span class="flex-shrink-0 font-medium">${this.scanProgress}%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${this.scanProgress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Results Area -->
                <div class="flex-1 overflow-auto">
                    ${this.renderScanResults()}
                </div>

                <!-- Status Bar -->
                <div class="bg-gray-800 px-3 sm:px-4 py-2 border-t border-gray-700 text-xs sm:text-sm">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-1 sm:gap-0">
                        <span class="truncate">${this.isScanning ? 'Scan in progress...' : `Scan complete - ${this.scanResults.length} threats found`}</span>
                        <span class="text-gray-300 text-xs">Level 3 Tournament Mode</span>
                    </div>
                </div>
            </div>
        `;
    }

    renderScanResults() {
        if (this.scanResults.length === 0) {
            return `
                <div class="h-full flex items-center justify-center text-gray-300 p-4">
                    <div class="text-center">
                        <i class="bi bi-shield-check text-4xl sm:text-5xl md:text-6xl mb-4"></i>
                        <p class="text-base sm:text-lg">No scan results yet</p>
                        <p class="text-sm">Click "Quick Scan" to start scanning for threats</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="p-3 sm:p-4">
                <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 flex items-center">
                    <i class="bi bi-exclamation-triangle text-red-500 mr-2"></i>
                    Detected Threats (${this.scanResults.length})
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    ${this.scanResults.map(threat => this.renderThreatCard(threat)).join('')}
                </div>
            </div>
        `;
    }

    renderThreatCard(threat) {
        const riskColor = level3DataManager.getRiskColor(threat.riskLevel);
        const isQuarantined = this.quarantinedItems.some(q => q.id === threat.id);
        const isFalsePositive = threat.isActualThreat === false;
        const iconClass = isFalsePositive ? 'bi bi-question-circle text-yellow-500' : 'bi bi-bug text-red-500';
        const borderClass = isFalsePositive ? 'border-yellow-600' : 'border-gray-700';
        
        return `
            <div class="bg-gray-800 border ${borderClass} rounded-lg p-3 sm:p-4 hover:bg-gray-750 transition-colors">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                            <div class="flex items-center space-x-2">
                                <i class="${iconClass}"></i>
                                <h4 class="font-semibold truncate">${threat.name}</h4>
                                ${isFalsePositive ? `<span class="px-2 py-1 rounded text-xs text-yellow-400 bg-yellow-900/20 border border-yellow-600/30">Suspicious</span>` : ''}
                            </div>
                            <div class="flex gap-2">
                                <span class="px-2 py-1 rounded text-xs ${riskColor} bg-gray-700 flex-shrink-0">${threat.riskLevel}</span>
                                <span class="px-2 py-1 rounded text-xs text-gray-300 bg-gray-700 flex-shrink-0">${threat.type}</span>
                            </div>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-300 mb-2 leading-relaxed">${threat.description}</p>
                        <div class="text-xs text-gray-400 space-y-1">
                            <div class="break-all"><strong>Path:</strong> ${threat.path}</div>
                            <div><strong>Size:</strong> ${threat.size}</div>
                            <div><strong>Type:</strong> ${threat.type}</div>
                            ${threat.signatures ? `
                                <div class="mt-1">
                                    <strong>Key Signatures:</strong>
                                    <ul class="list-disc list-inside ml-2 text-xs space-y-0.5">
                                        ${threat.signatures.slice(0, 2).map(sig => `<li class="break-words">${sig}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <div class="mt-1 text-yellow-400">
                                <strong>Potential Damage:</strong> ${threat.reputationDamage}% reputation, $${level3DataManager.formatDamage(threat.financialDamage)}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-row sm:flex-col gap-2 sm:space-y-2 sm:ml-4 flex-shrink-0">
                        ${!isQuarantined ? `
                            <button class="quarantine-btn px-3 py-1 bg-yellow-600 hover:bg-yellow-700 active:bg-yellow-800 rounded text-xs sm:text-sm transition-colors cursor-pointer touch-manipulation flex-1 sm:flex-auto" data-threat-id="${threat.id}">
                                <i class="bi bi-folder-lock mr-1"></i>Quarantine
                            </button>
                            <button class="delete-btn px-3 py-1 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded text-xs sm:text-sm transition-colors cursor-pointer touch-manipulation flex-1 sm:flex-auto" data-threat-id="${threat.id}">
                                <i class="bi bi-trash mr-1"></i>Delete
                            </button>
                        ` : `
                            <div class="px-3 py-1 bg-gray-600 rounded text-xs sm:text-sm text-center">
                                <i class="bi bi-check-circle text-green-400 mr-1"></i>Quarantined
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
    }

    async startQuickScan() {
        if (this.isScanning) return;

        this.isScanning = true;
        this.scanProgress = 0;
        this.scanResults = [];
        this.updateContent();

        const totalFiles = this.scanFiles.length;
        
        for (let i = 0; i < totalFiles; i++) {
            const filePath = this.scanFiles[i];
            const filename = filePath.split('\\').pop();
            this.currentScanFile = filename;
            this.scanProgress = Math.round(((i + 1) / totalFiles) * 100);
            
            // Check if file is malicious using path-based lookup
            const malware = level3DataManager.getMalwareByPath(filePath);
            if (malware) {
                const threat = {
                    ...malware,
                    id: `threat_${Date.now()}_${i}`,
                    detected: new Date().toLocaleString(),
                    isActualThreat: true
                };
                this.scanResults.push(threat);
                
                // Don't apply immediate damage - let gradual damage handle it
                console.log(`[MalwareScanner] Malware detected: ${threat.name} - gradual damage will apply`);
            } else if (this.falsePositiveFiles.includes(filePath)) {
                // Generate false positive for suspicious-looking legitimate files
                const falsePositive = this.generateFalsePositive(filePath, i);
                this.scanResults.push(falsePositive);
                console.log(`[MalwareScanner] False positive detected: ${falsePositive.name}`);
            }
            
            this.updateContent();
            
            // Use scan time from malware data or default for clean files
            const scanTime = malware ? malware.scanTime : 200;
            await this.sleep(scanTime);
        }

        this.isScanning = false;
        this.currentScanFile = '';
        this.updateContent();

        this.showNotification(`Scan complete! ${this.scanResults.length} threats detected`, 
                            this.scanResults.length > 0 ? 'error' : 'success');
    }

    // Generate false positive threats for legitimate but suspicious-looking files
    generateFalsePositive(filePath, index) {
        const filename = filePath.split('\\').pop();
        const falsePositiveData = {
            'system_update.exe': {
                name: 'System Update Assistant',
                type: 'Potentially Unwanted Program',
                riskLevel: 'Medium',
                description: 'Legitimate system update utility with suspicious characteristics'
            },
            'game_optimizer.exe': {
                name: 'Gaming Performance Optimizer',
                type: 'Adware',
                riskLevel: 'Low',
                description: 'Performance optimization tool with advertising components'
            },
            'steam_client_helper.exe': {
                name: 'Steam Client Helper Service',
                type: 'Potentially Unwanted Program',
                riskLevel: 'Low',
                description: 'Legitimate Steam helper with unusual network behavior'
            },
            'browser_cache_cleaner.exe': {
                name: 'Browser Cache Manager',
                type: 'Privacy Risk',
                riskLevel: 'Medium',
                description: 'Cache cleaning utility with data collection features'
            },
            'nvidia_updater.exe': {
                name: 'Graphics Driver Updater',
                type: 'Potentially Unwanted Program',
                riskLevel: 'Low',
                description: 'Driver update utility with telemetry collection'
            }
        };

        const data = falsePositiveData[filename] || {
            name: 'Unknown Suspicious Process',
            type: 'Potentially Unwanted Program',
            riskLevel: 'Medium',
            description: 'Process exhibiting suspicious behavior patterns'
        };

        return {
            id: `false_positive_${Date.now()}_${index}`,
            filename: filename,
            path: filePath,
            name: data.name,
            type: data.type,
            riskLevel: data.riskLevel,
            size: '1.2 MB',
            description: data.description,
            signatures: [
                'Heuristic analysis triggered',
                'Unusual file behavior detected',
                'Network activity patterns'
            ],
            behavior: [
                'Reads system configuration',
                'Establishes network connections',
                'Modifies temporary files'
            ],
            detected: new Date().toLocaleString(),
            isActualThreat: false, // This is a false positive
            reputationDamage: 0, // No real damage
            financialDamage: 0,
            scanTime: 1500,
            removalTime: 1000
        };
    }

    // Apply damage when malware is found (for manual triggering or special events)
    applyThreatDamage(threat) {
        if (!this.timer) {
            console.warn('[MalwareScanner] Timer not available for threat damage');
            return;
        }
        
        // Use damage values from malware data - this is for immediate one-time damage
        const reputationDamage = threat.reputationDamage || 15;
        const financialDamage = threat.financialDamage || 25000;
        
        console.log(`[MalwareScanner] Applying one-time threat damage: ${reputationDamage}% reputation, $${financialDamage} financial`);
        
        this.timer.addReputationDamage(reputationDamage, `Manual action required: ${threat.name}`);
        this.timer.addFinancialDamage(financialDamage, `Emergency response: ${threat.name}`);
    }

    quarantineThreat(threatId) {
        const threat = this.scanResults.find(t => t.id === threatId);
        if (threat && !this.quarantinedItems.some(q => q.id === threatId)) {
            this.quarantinedItems.push({
                ...threat,
                quarantinedAt: new Date().toISOString()
            });
            
            // Remove from scan results display (but keep in array for reference)
            this.scanResults = this.scanResults.filter(t => t.id !== threatId);
            this.updateContent();
            
            // Handle false positives vs real threats differently
            if (threat.isActualThreat === false) {
                // False positive - penalize the player
                this.showNotification(`âš ï¸ False Positive: ${threat.name} was legitimate! Avoid unnecessary quarantines.`, 'warning');
                
                // Apply minor reputation damage for false positive
                if (this.timer) {
                    this.timer.addReputationDamage(5, `False positive: quarantined legitimate file`);
                }
                
                // Record bad action in session summary
                if (window.level3SessionSummary) {
                    window.level3SessionSummary.recordAction(false);
                }
            } else {
                // Real threat - reward the player
                this.showNotification(`âœ… ${threat.name} quarantined successfully`, 'success');
                
                // Record good action in session summary
                if (window.level3SessionSummary) {
                    window.level3SessionSummary.recordAction(true);
                }
            }
            
            this.checkStageCompletion();
        }
    }

    deleteThreat(threatId) {
        const threat = this.scanResults.find(t => t.id === threatId);
        if (threat) {
            // Mark as deleted and remove from scan results
            this.deletedItems.push(threat);
            this.scanResults = this.scanResults.filter(t => t.id !== threatId);
            this.updateContent();
            
            // Handle false positives vs real threats differently
            if (threat.isActualThreat === false) {
                // False positive - major penalty for deleting legitimate file
                this.showNotification(`ðŸš¨ CRITICAL: ${threat.name} was legitimate! System damage from deleting valid file!`, 'error');
                
                // Apply major reputation and financial damage for deleting legitimate file
                if (this.timer) {
                    this.timer.addReputationDamage(15, `Critical error: deleted legitimate file`);
                    this.timer.addFinancialDamage(5000, `System damage from deleting ${threat.name}`);
                }
                
                // Record bad action in session summary
                if (window.level3SessionSummary) {
                    window.level3SessionSummary.recordAction(false);
                }
            } else {
                // Real threat - reward the player
                this.showNotification(`âœ… ${threat.name} permanently deleted`, 'success');
                
                // Record good action in session summary
                if (window.level3SessionSummary) {
                    window.level3SessionSummary.recordAction(true);
                }
            }
            
            this.checkStageCompletion();
        }
    }
    
    checkStageCompletion() {
        // Ensure data is loaded before checking
        if (!level3DataManager.loaded) {
            console.log('[MalwareScanner] Data manager not loaded, retrying stage completion check...');
            setTimeout(() => this.checkStageCompletion(), 1000);
            return;
        }
        
        const malwareData = level3DataManager.getAllMalware();
        const malwareCount = Object.keys(malwareData).length;
        
        // Only count real threats (not false positives) for completion
        const realThreatsHandled = [...this.quarantinedItems, ...this.deletedItems]
            .filter(item => item.isActualThreat !== false).length;
        
        console.log(`[MalwareScanner] Stage completion check:`, {
            malwareCount,
            quarantined: this.quarantinedItems.length,
            deleted: this.deletedItems.length,
            realThreatsHandled,
            malwareData: Object.keys(malwareData)
        });
        
        if (realThreatsHandled >= malwareCount && malwareCount > 0) {
            console.log(`[MalwareScanner] Stage complete! All ${malwareCount} real malware threats handled`);
            this.onStageComplete();
        } else if (malwareCount === 0) {
            console.warn('[MalwareScanner] No malware data available for stage completion check');
        }
    }
    
    onStageComplete() {
        console.log('[MalwareScanner] onStageComplete called - stopping malware damage and triggering level completion');
        
        // Record stage completion in session summary
        if (window.level3SessionSummary) {
            const timeSpent = this.timer ? ((15 * 60) - this.timer.timeRemaining) : 0;
            window.level3SessionSummary.recordStageCompletion('malware-scanner', timeSpent);
        }
        
        // Stop gradual damage
        if (this.damageInterval) {
            clearInterval(this.damageInterval);
            this.damageInterval = null;
            console.log('[MalwareScanner] Gradual damage stopped');
        }
        
        this.showNotification('All malware threats eliminated! The system is now clean.', 'success');
        
        // Trigger level completion after a short delay
        setTimeout(async () => {
            console.log('[MalwareScanner] Triggering level completion dialogue');
            
            // Import and trigger the completion dialogue
            try {
                const { Level3MalwareMayhemDialogue } = await import('../dialogues/level3-malware-mayhem.js');
                
                // Get desktop reference
                const desktop = window.desktop;
                if (desktop) {
                    Level3MalwareMayhemDialogue.triggerLevelThreeCompletionDialogue(desktop);
                } else {
                    console.error('[MalwareScanner] No desktop reference available for completion dialogue');
                }
            } catch (error) {
                console.error('[MalwareScanner] Failed to trigger completion dialogue:', error);
            }
        }, 2000);
    }

    // Manual trigger for testing stage completion
    forceStageCompletion() {
        console.log('[MalwareScanner] Force stage completion triggered');
        this.onStageComplete();
    }

    startGradualDamage() {
        // Apply gradual damage every 10 seconds while malware exists in scan results
        this.damageInterval = setInterval(() => {
            const activeMalware = this.scanResults.filter(t => 
                t.riskLevel === 'Critical' || t.riskLevel === 'High'
            );
            
            if (activeMalware.length > 0 && this.timer) {
                // Calculate damage based on actual malware data
                let totalReputationDamage = 0;
                let totalFinancialDamage = 0;
                
                activeMalware.forEach(malware => {
                    // Use a smaller fraction of the total damage as gradual damage (5% every 10 seconds)
                    totalReputationDamage += Math.floor((malware.reputationDamage || 15) * 0.05);
                    totalFinancialDamage += Math.floor((malware.financialDamage || 25000) * 0.05);
                });
                
                if (totalReputationDamage > 0) {
                    this.timer.addReputationDamage(totalReputationDamage, 'Ongoing malware activity');
                }
                if (totalFinancialDamage > 0) {
                    this.timer.addFinancialDamage(totalFinancialDamage, 'Ongoing security breach costs');
                }
                
                console.log(`[MalwareScanner] Gradual damage applied: ${totalReputationDamage}% reputation, $${totalFinancialDamage} financial`);
            }
        }, 10000); // Every 10 seconds (more frequent)
    }

    stopScan() {
        this.isScanning = false;
        this.currentScanFile = '';
        this.updateContent();
    }

    clearResults() {
        this.scanResults = [];
        this.updateContent();
    }

    initialize() {
        super.initialize();
        this.bindEvents();
        
        // Mark app as opened
        localStorage.setItem('cyberquest_malwarescanner_opened', 'true');
    }

    bindEvents() {
        if (!this.windowElement) return;

        // Scan controls
        const quickScanBtn = this.windowElement.querySelector('#quick-scan-btn');
        const stopScanBtn = this.windowElement.querySelector('#stop-scan-btn');
        const clearResultsBtn = this.windowElement.querySelector('#clear-results-btn');
        const quarantineViewBtn = this.windowElement.querySelector('#quarantine-view-btn');

        console.log('[MalwareScanner] Button elements found:', {
            quickScanBtn: !!quickScanBtn,
            stopScanBtn: !!stopScanBtn,
            clearResultsBtn: !!clearResultsBtn,
            quarantineViewBtn: !!quarantineViewBtn
        });

        quickScanBtn?.addEventListener('click', () => this.startQuickScan());
        stopScanBtn?.addEventListener('click', () => this.stopScan());
        clearResultsBtn?.addEventListener('click', () => this.clearResults());
        quarantineViewBtn?.addEventListener('click', () => {
            console.log('[MalwareScanner] Quarantine view button clicked');
            this.showQuarantineView();
        });

        // Threat actions
        this.windowElement.addEventListener('click', (e) => {
            if (e.target.matches('.quarantine-btn, .quarantine-btn *')) {
                const btn = e.target.closest('.quarantine-btn');
                const threatId = btn?.dataset.threatId;
                if (threatId) this.quarantineThreat(threatId);
            }
            
            if (e.target.matches('.delete-btn, .delete-btn *')) {
                const btn = e.target.closest('.delete-btn');
                const threatId = btn?.dataset.threatId;
                if (threatId) this.deleteThreat(threatId);
            }
        });
    }

    showQuarantineView() {
        console.log('[MalwareScanner] showQuarantineView called, quarantined items:', this.quarantinedItems.length);
        
        // Remove any existing modal first
        const existingModal = document.getElementById('quarantine-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Create modal HTML
        const modalHtml = `
            <div id="quarantine-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="bg-gray-800 rounded-lg w-full max-w-xs sm:max-w-lg md:max-w-2xl lg:max-w-4xl h-full max-h-screen sm:h-4/5 flex flex-col">
                    <!-- Modal Header -->
                    <div class="bg-purple-600 px-3 sm:px-4 py-3 rounded-t-lg border-b border-gray-700">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <i class="bi bi-folder-lock text-xl sm:text-2xl text-white"></i>
                                <div>
                                    <h2 class="text-base sm:text-lg font-bold text-white">Quarantine Manager</h2>
                                    <p class="text-xs sm:text-sm text-purple-100">Level 3 - Isolated Threats</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-purple-100 text-xs sm:text-sm">${this.quarantinedItems.length} items</span>
                                <button id="close-quarantine-modal" class="text-white hover:text-red-300 transition-colors cursor-pointer touch-manipulation">
                                    <i class="bi bi-x-lg text-lg sm:text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Content -->
                    <div class="flex-1 overflow-auto p-3 sm:p-4 text-white">
                        ${this.renderQuarantineContent()}
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-700 px-3 sm:px-4 py-3 rounded-b-lg border-t border-gray-600">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0">
                            <div class="text-xs sm:text-sm text-gray-300">
                                Items in quarantine are isolated and cannot execute
                            </div>
                            <div class="flex gap-2">
                                <button id="clear-quarantine-btn" class="flex-1 sm:flex-auto px-3 sm:px-4 py-2 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded transition-colors cursor-pointer touch-manipulation text-sm">
                                    <i class="bi bi-trash mr-1 sm:mr-2"></i>Clear All
                                </button>
                                <button id="close-quarantine-modal-btn" class="flex-1 sm:flex-auto px-3 sm:px-4 py-2 bg-gray-600 hover:bg-gray-700 active:bg-gray-800 rounded transition-colors cursor-pointer touch-manipulation text-sm">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Bind modal events
        this.bindQuarantineModalEvents();
    }

    renderQuarantineContent() {
        if (this.quarantinedItems.length === 0) {
            return `
                <div class="h-full flex items-center justify-center text-gray-300 p-4">
                    <div class="text-center">
                        <i class="bi bi-shield-check text-4xl sm:text-5xl md:text-6xl mb-4"></i>
                        <p class="text-base sm:text-lg">No quarantined items</p>
                        <p class="text-sm">Threats that are quarantined will appear here</p>
                    </div>
                </div>
            `;
        }

        return `
            <div>
                <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 flex items-center">
                    <i class="bi bi-folder-lock text-purple-400 mr-2"></i>
                    Quarantined Threats (${this.quarantinedItems.length})
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    ${this.quarantinedItems.map(item => this.renderQuarantineItem(item)).join('')}
                </div>
            </div>
        `;
    }

    renderQuarantineItem(item) {
        const riskColor = level3DataManager.getRiskColor(item.riskLevel);
        const quarantineDate = new Date(item.quarantinedAt).toLocaleString();
        
        return `
            <div class="bg-gray-700 border border-gray-600 rounded-lg p-3 sm:p-4 hover:bg-gray-650 transition-colors">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                            <div class="flex items-center space-x-2">
                                <i class="bi bi-lock text-purple-400"></i>
                                <h4 class="font-semibold text-white truncate">${item.name}</h4>
                            </div>
                            <div class="flex gap-2">
                                <span class="px-2 py-1 rounded text-xs ${riskColor} bg-gray-800 flex-shrink-0">${item.riskLevel}</span>
                                <span class="px-2 py-1 rounded text-xs text-gray-300 bg-gray-800 flex-shrink-0">${item.type}</span>
                            </div>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-400 mb-2 leading-relaxed">${item.description}</p>
                        <div class="text-xs text-gray-400 space-y-1">
                            <div class="break-all"><strong>Original Path:</strong> ${item.path}</div>
                            <div><strong>Size:</strong> ${item.size}</div>
                            <div><strong>Type:</strong> ${item.type}</div>
                            <div><strong>Quarantined:</strong> ${quarantineDate}</div>
                            ${item.origin ? `<div class="break-words"><strong>Origin:</strong> ${item.origin}</div>` : ''}
                            <div class="mt-1 text-orange-400">
                                <strong>Potential Damage:</strong> ${item.reputationDamage}% reputation, $${level3DataManager.formatDamage(item.financialDamage)}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-row sm:flex-col gap-2 sm:space-y-2 sm:ml-4 flex-shrink-0">
                        <button class="restore-btn px-3 py-1 bg-green-600 hover:bg-green-700 active:bg-green-800 rounded text-xs sm:text-sm transition-colors cursor-pointer touch-manipulation flex-1 sm:flex-auto" data-item-id="${item.id}">
                            <i class="bi bi-arrow-counterclockwise mr-1"></i>Restore
                        </button>
                        <button class="delete-quarantine-btn px-3 py-1 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded text-xs sm:text-sm transition-colors cursor-pointer touch-manipulation flex-1 sm:flex-auto" data-item-id="${item.id}">
                            <i class="bi bi-trash mr-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    bindQuarantineModalEvents() {
        const modal = document.getElementById('quarantine-modal');
        if (!modal) return;

        // Close modal events
        const closeButtons = modal.querySelectorAll('#close-quarantine-modal, #close-quarantine-modal-btn');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => this.closeQuarantineModal());
        });

        // Close on background click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.closeQuarantineModal();
            }
        });

        // Clear all quarantine
        const clearAllBtn = modal.querySelector('#clear-quarantine-btn');
        clearAllBtn?.addEventListener('click', () => this.clearAllQuarantine());

        // Item actions
        modal.addEventListener('click', (e) => {
            if (e.target.matches('.restore-btn, .restore-btn *')) {
                const btn = e.target.closest('.restore-btn');
                const itemId = btn?.dataset.itemId;
                if (itemId) this.restoreFromQuarantine(itemId);
            }
            
            if (e.target.matches('.delete-quarantine-btn, .delete-quarantine-btn *')) {
                const btn = e.target.closest('.delete-quarantine-btn');
                const itemId = btn?.dataset.itemId;
                if (itemId) this.deleteFromQuarantine(itemId);
            }
        });
    }

    closeQuarantineModal() {
        const modal = document.getElementById('quarantine-modal');
        if (modal) {
            modal.remove();
        }
    }

    restoreFromQuarantine(itemId) {
        const itemIndex = this.quarantinedItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            const item = this.quarantinedItems[itemIndex];
            
            // Remove from quarantine
            this.quarantinedItems.splice(itemIndex, 1);
            
            // Add back to scan results
            this.scanResults.push(item);
            
            // Update displays
            this.updateQuarantineModal();
            this.updateContent();
            
            // Check stage completion since quarantine count changed
            this.checkStageCompletion();
            
            this.showNotification(`${item.name} restored from quarantine`, 'info');
        }
    }

    deleteFromQuarantine(itemId) {
        const itemIndex = this.quarantinedItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            const item = this.quarantinedItems[itemIndex];
            
            // Remove from quarantine permanently
            this.quarantinedItems.splice(itemIndex, 1);
            
            // Add to deleted items so it counts toward completion
            this.deletedItems.push(item);
            
            // Update displays
            this.updateQuarantineModal();
            this.updateContent();
            
            // Check stage completion since we now have more deleted items
            this.checkStageCompletion();
            
            this.showNotification(`${item.name} permanently deleted`, 'success');
        }
    }

    clearAllQuarantine() {
        if (this.quarantinedItems.length === 0) return;
        
        const count = this.quarantinedItems.length;
        this.quarantinedItems = [];
        
        // Update displays
        this.updateQuarantineModal();
        this.updateContent();
        
        this.showNotification(`${count} items cleared from quarantine`, 'success');
    }

    updateQuarantineModal() {
        const modal = document.getElementById('quarantine-modal');
        if (modal) {
            // Update item count in header
            const itemCount = modal.querySelector('.text-purple-100');
            if (itemCount) {
                itemCount.textContent = `${this.quarantinedItems.length} items`;
            }
            
            // Update content
            const content = modal.querySelector('.flex-1.overflow-auto');
            if (content) {
                content.innerHTML = `<div class="p-4 text-white">${this.renderQuarantineContent()}</div>`;
            }
        }
    }

    showNotification(message, type = 'info') {
        if (window.toastManager && window.toastManager.showToast) {
            window.toastManager.showToast(message, type);
        } else {
            console.log(`[MalwareScanner] ${type.toUpperCase()}: ${message}`);
        }
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    cleanup() {
        this.stopScan();
        
        // Stop gradual damage interval
        if (this.damageInterval) {
            clearInterval(this.damageInterval);
            this.damageInterval = null;
        }
        
        super.cleanup();
    }
}